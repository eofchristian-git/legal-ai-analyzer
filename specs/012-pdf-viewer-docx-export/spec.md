# Feature Specification: PDF Document Viewer & Original-File Export

**Feature Branch**: `012-pdf-viewer-docx-export`  
**Created**: 2026-02-20  
**Status**: Draft  
**Input**: User description: "PDF viewer with annotation overlays and server-side DOCX export with native tracked changes"

## Clarifications

### Session 2026-02-20

- Q: What information should each exported Word comment contain — user notes only, notes + AI summary + risk, everything including escalation/playbook details, or configurable? → A: User notes + AI finding summary + risk level. Each comment includes the risk flag, a brief AI summary of the issue, and any reviewer-typed notes. Internal workflow artifacts (escalation reasons, playbook rule references) are excluded from export comments.
- Q: Should the new "Original with Changes" Word export replace the existing reconstructed DOCX export or coexist with it? → A: Replace. The new export becomes the sole Word export option. The existing reconstructed export is deprecated and removed.
- Q: What name should appear as the author of tracked changes and Word comments in the exported document? → A: A fixed system name (e.g., "Legal AI Analyzer"). This makes it clear to recipients that changes were generated by an automated review tool, not a specific individual.

---

## Background

The contract review workflow requires legal reviewers to view uploaded contracts, see AI-identified risk highlights, navigate between clauses, apply fallback language (replacement text), add notes, and export the final document with all changes. The current document viewer has fundamental reliability issues: clause navigation fails for approximately 15-30% of clauses, applying changes takes 3-5 seconds each with no confirmation of success, and the document takes up to 18 seconds to prepare before a reviewer can interact with it. Additionally, the current export either produces a potentially corrupted file (if in-viewer modifications failed) or a completely reconstructed document that loses the original formatting, headers, logos, tables, and page layout.

This feature replaces the document viewing and export system to deliver deterministic navigation, instant visual feedback, and faithful export of the original contract file with all triage modifications preserved.

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - View Contract with Risk Highlights (Priority: P1)

A legal reviewer opens an analyzed contract to begin triage. The document renders with high fidelity — preserving the original layout, fonts, headers, and page structure. Risk-level highlights (red, yellow, green) are immediately visible on the relevant clauses and findings. The reviewer can scroll through the document naturally and see all AI-identified areas of concern at a glance without waiting for a lengthy preparation phase.

**Why this priority**: This is the foundation of the entire review workflow. Without a reliable, fast document display with visible risk indicators, no other feature can function. It replaces the 18-second preparation wait and the unreliable highlighting that currently fails on some clauses.

**Independent Test**: Upload a contract, run analysis, then open the contract detail page. The document should be visible and scrollable within 3 seconds, with all risk highlights already present.

**Acceptance Scenarios**:

1. **Given** a contract has completed AI analysis, **When** the reviewer opens the contract detail page, **Then** the document is visible and scrollable within 3 seconds with the original layout preserved (fonts, tables, headers, logos, page breaks).
2. **Given** a document has 20+ findings across multiple risk levels, **When** the document first renders, **Then** all findings are highlighted with their correct risk-level colors (red for high risk, yellow for medium, green for low) — no progressive/delayed highlighting occurs.
3. **Given** a large contract (50+ pages), **When** the reviewer scrolls through the document, **Then** pages load smoothly without noticeable lag or blank areas.

---

### User Story 2 - Navigate Between Clauses (Priority: P1)

A legal reviewer clicks a clause in the left-panel clause list. The document immediately scrolls to the exact location of that clause in the contract. The reviewer can click any clause in any order and reliably land on the correct position every time. When the reviewer scrolls the document manually, the clause list highlights which clause is currently visible.

**Why this priority**: Clause navigation is a core interaction that reviewers use hundreds of times per session. The current system fails for 15-30% of clauses. Reliable navigation is essential for an efficient review workflow and is the main feature of the platform.

**Independent Test**: Open any analyzed contract. Click each clause in the left panel and verify the document scrolls to the correct location. Scroll the document manually and verify the clause list updates to reflect the visible clause.

**Acceptance Scenarios**:

1. **Given** a contract with analyzed clauses, **When** the reviewer clicks a clause in the left panel, **Then** the document scrolls to display the start of that clause within 300 milliseconds.
2. **Given** a contract with 30+ clauses, **When** the reviewer clicks each clause sequentially, **Then** navigation succeeds for at least 95% of clauses (up from 70-85% with the current system).
3. **Given** the reviewer is scrolling through the document, **When** a new clause comes into the viewport, **Then** the clause list panel highlights the corresponding clause automatically.
4. **Given** the reviewer clicks the same clause twice in a row, **When** the second click occurs, **Then** the document still scrolls to (or confirms position at) that clause.

---

### User Story 3 - Apply Fallback Language and See Changes Instantly (Priority: P1)

During triage, when a reviewer decides a clause needs replacement text (fallback language), they apply the fallback through the existing clause action workflow. The document immediately shows the original text with a visual strikethrough indicator and the replacement text displayed as a clearly distinguished annotation — all within half a second. This visual change persists as the reviewer continues working on other clauses.

**Why this priority**: Applying fallback language is the primary action reviewers take to resolve risky clauses. The current 3.5-second delay with no success confirmation breaks the review flow and undermines confidence. Instant feedback is critical for productivity.

**Independent Test**: Open an analyzed contract with at least one finding that has suggested fallback language. Apply the fallback. Verify the document updates visually within 500ms showing the original text marked for deletion and the replacement text clearly visible.

**Acceptance Scenarios**:

1. **Given** a finding has suggested fallback language, **When** the reviewer applies the fallback, **Then** the document updates within 500 milliseconds to show the original text with a strikethrough indicator and the replacement text in a visually distinct annotation.
2. **Given** a fallback has been applied, **When** the reviewer navigates away from that clause and returns later, **Then** the applied fallback (strikethrough + replacement) is still visible.
3. **Given** multiple fallbacks have been applied across different clauses, **When** the reviewer scrolls through the document, **Then** all applied changes are consistently visible on their respective clauses.
4. **Given** a fallback was applied in error, **When** the reviewer undoes the fallback, **Then** the strikethrough and replacement annotation disappear and the original text appears clean again — within 500 milliseconds.

---

### User Story 4 - Export Original Contract with All Changes (Priority: P1)

After completing the triage workflow, the reviewer exports the contract. The exported file IS the original uploaded document — with the same formatting, headers, logos, tables, and page layout — but with all triage modifications embedded inline: replaced text appears as tracked deletions and insertions (so the recipient can Accept or Reject each change individually), and triage notes appear as margin comments. The reviewer can choose to export as a Word document.

**Why this priority**: This is the ultimate deliverable of the entire review workflow. The export must be the original contract — not a reconstructed approximation — because the recipient (counterparty, internal legal team) expects to see and interact with the exact document they sent, augmented with proposed changes. Losing original formatting or building a new document undermines the credibility of the review.

**Independent Test**: Complete a full triage on a contract (apply fallbacks to at least 3 clauses, add notes to 2 clauses). Export as Word document. Open in Microsoft Word. Verify: (1) original formatting is preserved, (2) tracked changes appear with Accept/Reject functionality, (3) triage notes appear as margin comments.

**Acceptance Scenarios**:

1. **Given** a contract has been fully triaged with applied fallbacks and notes, **When** the reviewer clicks "Export" and selects "Original with Changes (.docx)", **Then** a Word file downloads that preserves all original formatting (fonts, tables, headers, footers, logos, page layout).
2. **Given** the exported Word file, **When** opened in Microsoft Word, **Then** replaced text appears as tracked changes (strikethrough for deleted text, underline for inserted text) with Accept/Reject buttons available in the Review tab.
3. **Given** the exported Word file, **When** opened in Microsoft Word, **Then** triage notes and finding summaries appear as margin comments anchored to the relevant clause text.
4. **Given** the reviewer has applied 5 fallbacks and added 3 notes, **When** the file is exported, **Then** all 5 tracked changes and all 3 comments are present and correctly positioned.
5. **Given** no triage changes have been made, **When** the reviewer exports the document, **Then** the exported file is identical to the original uploaded document.

---

### User Story 5 - View Triage Notes and Comments in Document (Priority: P2)

During or after triage, the reviewer can see notes, escalation reasons, and finding summaries displayed alongside the relevant clause text in the document view. These annotations appear in the margin or as callout boxes near the clause they reference, providing context without obscuring the original document text.

**Why this priority**: While not blocking the primary triage flow, visible notes improve the reviewer's ability to track decisions and share context when multiple people are involved in the review process.

**Independent Test**: Add a note to a clause decision. Verify the note appears in the document view near the relevant clause. Add an escalation with a reason. Verify the escalation reason is visible.

**Acceptance Scenarios**:

1. **Given** a clause decision has a triage note, **When** the reviewer views the document, **Then** the note text appears as a visible annotation near the corresponding clause.
2. **Given** a finding has been escalated with a reason, **When** the reviewer views the document, **Then** the escalation reason is displayed as an annotation on the relevant finding.
3. **Given** multiple notes exist across different clauses, **When** the reviewer scrolls through the document, **Then** each note appears at its correct position without overlapping or obscuring other content.

---

### User Story 6 - Export Annotated PDF (Priority: P3)

The reviewer can export the contract as an annotated PDF that includes the visual overlays (risk highlights, strikethrough, replacement text, notes) baked into the PDF file. This is useful for sharing a read-only snapshot of the review state with stakeholders who don't need to interact with tracked changes.

**Why this priority**: This is a convenience feature. The primary export (Word with tracked changes) covers the main use case. PDF export serves secondary sharing needs.

**Independent Test**: Complete a triage, export as annotated PDF. Open the PDF and verify risk highlights, strikethrough, and notes are visible.

**Acceptance Scenarios**:

1. **Given** a contract has been triaged, **When** the reviewer exports as "Annotated PDF", **Then** a PDF downloads that includes risk-level color highlights, strikethrough on replaced text, replacement text annotations, and triage notes.
2. **Given** the annotated PDF, **When** viewed in any standard PDF reader, **Then** all annotations are visible and the original document layout is preserved.

---

### User Story 7 - No External Service Required for Viewing (Priority: P2)

The document viewer works without depending on an external document editing service running in a separate container. The system only requires a one-time document conversion step during the analysis phase. If the conversion service is temporarily unavailable, previously converted documents can still be viewed normally.

**Why this priority**: Reducing infrastructure dependencies improves reliability and simplifies deployment. The current system requires a continuously running external service for every page view, adding a single point of failure.

**Independent Test**: Stop the document conversion service after a contract has been analyzed. Open the contract — verify the document still renders and the viewer is fully functional.

**Acceptance Scenarios**:

1. **Given** a contract has been analyzed and its document converted, **When** the conversion service is stopped, **Then** the reviewer can still open, view, navigate, and interact with the document.
2. **Given** a new contract is uploaded but the conversion service is unavailable, **When** the reviewer tries to view it, **Then** a clear error message explains that the document is being prepared and will be available when the service is restored.

---

### Edge Cases

- What happens when a clause excerpt cannot be matched to a position in the rendered document? The clause should still appear in the clause list with an indicator that its position could not be determined. Navigation for that clause should show a non-blocking warning.
- What happens when the original uploaded file is corrupted or uses an unsupported format? The system should display a clear error message and prevent analysis from proceeding with a corrupted document.
- What happens when a contract has 200+ pages? The viewer should use virtualized rendering so only visible pages are loaded, keeping memory usage and scroll performance acceptable.
- What happens when a fallback text excerpt appears multiple times in the document? The system should match to the correct occurrence based on the surrounding context captured during analysis.
- What happens when a finding's excerpt spans multiple paragraphs? The highlight and tracked change should span across paragraph boundaries correctly.
- What happens when the exported DOCX is opened in a non-Microsoft editor (Google Docs, LibreOffice)? Tracked changes should be visible, though Accept/Reject UI may differ by editor. The specification targets Microsoft Word as the primary export consumer.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST render uploaded contracts as read-only documents preserving original visual layout (fonts, tables, headers, footers, logos, page breaks).
- **FR-002**: System MUST display risk-level highlights (red, yellow, green) over all AI-identified findings at the time the document first renders — not applied progressively after initial display.
- **FR-003**: System MUST support deterministic clause navigation — clicking a clause in the left panel scrolls the document to the clause position with >95% reliability.
- **FR-004**: System MUST support reverse scroll-sync — scrolling the document updates the selected clause in the left panel to match the currently visible clause.
- **FR-005**: System MUST visually reflect applied fallback language within 500ms — showing strikethrough on original text and the replacement text as a distinct annotation.
- **FR-006**: System MUST visually reflect undone fallbacks within 500ms — removing the strikethrough and replacement annotation to restore the original appearance.
- **FR-007**: System MUST display triage notes, escalation reasons, and finding summaries as annotations in the document view near the relevant clause.
- **FR-008**: System MUST export a Word document that IS the original uploaded file, augmented with inline tracked changes (deletions and insertions) for each applied fallback, preserving all original formatting. This export replaces the existing reconstructed DOCX export and becomes the sole Word export option.
- **FR-009**: System MUST export Word comments anchored to the relevant clause text, containing: the risk level indicator (e.g., "⚠ RED"), the AI-generated finding summary, and any reviewer-typed notes. Internal workflow data (escalation reasons, playbook rule references) is excluded from exported comments.
- **FR-010**: System MUST support Accept/Reject functionality for tracked changes when the exported Word file is opened in Microsoft Word. All tracked changes and comments MUST be attributed to a fixed system author name (e.g., "Legal AI Analyzer"), not the individual reviewer.
- **FR-011**: System MUST support exporting an annotated PDF with visual overlays (highlights, strikethrough, replacement text, notes) baked into the file.
- **FR-012**: System MUST NOT require an external document editing service to be running at the time of document viewing. Document conversion should occur once during the analysis phase.
- **FR-013**: System MUST use virtualized rendering for large documents (50+ pages) so that only visible pages are loaded into memory.
- **FR-014**: System MUST store text position mappings (clause-to-document-position) at analysis time, not compute them at view time.
- **FR-015**: System MUST handle documents where some clause/finding excerpts cannot be matched to positions — display those clauses in the list with an unmapped indicator and degrade gracefully.
- **FR-016**: All triage decisions (fallback applications, notes, escalations) MUST remain stored in the database as the source of truth. The document viewer reflects database state; it does not store changes in the file.

### Key Entities

- **PDF Document**: A converted representation of the original contract, generated once at analysis time. Used for display only. Attributes: file path, conversion status, page count.
- **Text Position**: Character-level coordinate data extracted from the PDF document. Each position represents a text span with its page, location (x, y), and dimensions. Used for mapping clauses/findings to visual locations.
- **Clause Position Mapping**: Links an analyzed clause to one or more positions in the PDF document. Enables deterministic navigation — click a clause, scroll to its position.
- **Finding Position Mapping**: Links an individual finding to its highlighted region(s) in the PDF. Includes the risk level for coloring. Enables risk highlights and redline overlays.
- **Clause Decision** *(existing)*: The append-only event log of all triage actions (approve, apply fallback, escalate, add note, undo). Projections computed from this log drive the visual overlays and the export content.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Clause navigation succeeds for at least 95% of clauses in a typical contract (compared to 70-85% with the previous system).
- **SC-002**: The document is visible and interactive within 3 seconds of opening the contract detail page (compared to up to 18 seconds previously).
- **SC-003**: Applying or undoing a fallback visually updates the document within 500 milliseconds (compared to 3.5 seconds previously).
- **SC-004**: Exported Word documents preserve all original formatting elements — headers, footers, logos, fonts, tables, and page layout — as verified by visual comparison with the uploaded original.
- **SC-005**: Tracked changes in exported Word documents are fully functional in Microsoft Word — each change can be individually Accepted or Rejected via the Review tab.
- **SC-006**: Triage notes appear as Word comments in exported documents, anchored to the correct clause text.
- **SC-007**: The document viewer operates without requiring an external document editing service at view time — the service is only needed during the one-time analysis-phase conversion.
- **SC-008**: Large documents (100+ pages) scroll smoothly without noticeable lag, with pages rendering on demand.
